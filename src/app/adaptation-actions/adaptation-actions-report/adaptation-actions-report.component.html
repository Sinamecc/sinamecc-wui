<div class="container-custom">
  <div class="header-container flex flex-col justify-center items-center">
    <h2 translate>adaptationAction.form2.title</h2>
  </div>
  <form [formGroup]="form">
    <mat-vertical-stepper linear #stepper formArrayName="formArray">
      <mat-step formGroupName="0" [stepControl]="formArray?.get([0])">
        <ng-template matStepLabel>
          <span translate>adaptationAction.form2.registerInfo</span>
          <mat-icon
            (click)="goToLink('https://drive.google.com/file/d/1m74UIubAhJdOlfRSSPNgv-j86rQY1rUk/view?usp=sharing')"
            [matTooltip]="'adaptationAction.form2.registerInfoTooltip' | translate"
            >info</mat-icon
          >
        </ng-template>

        <label translate>adaptationAction.form2.AAType</label>
        <mat-radio-group
          (change)="changeAdaptationType($event.value)"
          #reportingEntityTypeControl="matRadioGroup"
          formControlName="adaptationActionTypeCtrl"
          class="custom-radio-group"
        >
          <mat-radio-button [matTooltip]="typesTooltipTxt[0]" value="1">
            <label translate>Tipo A - Instrumentos de pol√≠ticas y planes </label>
          </mat-radio-button>
          <mat-radio-button [matTooltip]="typesTooltipTxt[1]" value="2">
            <label translate>Tipo B - Proyectos y programas</label>
          </mat-radio-button>
          <mat-radio-button [matTooltip]="typesTooltipTxt[2]" value="3">
            <label translate>Tipo C - Actividades</label>
          </mat-radio-button>
        </mat-radio-group>

        <mat-form-field class="field-ppcn">
          <mat-label translate>adaptationAction.form2.AAName</mat-label>
          <input type="text" matInput formControlName="adaptationActionNameCtrl" />
          <mat-error *ngIf="formArray?.get([0])?.get('adaptationActionNameCtrl')?.hasError('required')" translate>
            errorLabel.fieldRequired
          </mat-error>
          <mat-error *ngIf="formArray?.get([0])?.get('adaptationActionNameCtrl')?.hasError('maxlength')" translate>
            errorLabel.maxLengthExceeded
          </mat-error>
        </mat-form-field>

        <mat-form-field class="field-ppcn">
          <mat-label translate>adaptationAction.form2.AAObjective</mat-label>
          <input type="text" matInput formControlName="adaptationActionTargetCtrl" />
          <mat-error *ngIf="formArray?.get([0])?.get('adaptationActionTargetCtrl')?.hasError('required')" translate>
            errorLabel.fieldRequired
          </mat-error>
          <mat-error *ngIf="formArray?.get([0])?.get('adaptationActionTargetCtrl')?.hasError('maxlength')" translate>
            errorLabel.maxLengthExceeded
          </mat-error>
        </mat-form-field>

        <mat-form-field class="field-ppcn">
          <mat-label translate>adaptationAction.form2.AADescription</mat-label>
          <input type="text" matInput formControlName="adaptationActionDescriptionCtrl" />
          <mat-error
            *ngIf="formArray?.get([0])?.get('adaptationActionDescriptionCtrl')?.hasError('required')"
            translate
          >
            errorLabel.fieldRequired
          </mat-error>
          <mat-error
            *ngIf="formArray?.get([0])?.get('adaptationActionDescriptionCtrl')?.hasError('maxlength')"
            translate
          >
            errorLabel.maxLengthExceeded
          </mat-error>
        </mat-form-field>

        <mat-form-field class="field-ppcn">
          <mat-label translate>adaptationAction.form2.AAGoal</mat-label>
          <input type="text" matInput formControlName="adaptationActionGoalCtrl" />
          <mat-error *ngIf="formArray?.get([0])?.get('adaptationActionGoalCtrl')?.hasError('required')" translate>
            errorLabel.fieldRequired
          </mat-error>
          <mat-error *ngIf="formArray?.get([0])?.get('adaptationActionGoalCtrl')?.hasError('maxlength')" translate>
            errorLabel.maxLengthExceeded
          </mat-error>
        </mat-form-field>

        <mat-form-field class="field-ppcn">
          <mat-label translate>adaptationAction.form2.expectedResults</mat-label>
          <input type="text" matInput formControlName="expectedResultsCtrl" />
          <mat-error *ngIf="formArray?.get([0])?.get('expectedResultsCtrl')?.hasError('required')" translate>
            errorLabel.fieldRequired
          </mat-error>
          <mat-error *ngIf="formArray?.get([0])?.get('expectedResultsCtrl')?.hasError('maxlength')" translate>
            errorLabel.maxLengthExceeded
          </mat-error>
        </mat-form-field>

        <mat-form-field class="field-ppcn" appearance="fill">
          <mat-label translate>adaptationAction.form2.beneficiaryPopulation</mat-label>
          <mat-select formControlName="beneficiaryPopulationCtrl" multiple>
            <mat-option *ngFor="let benefied of benefiedPopulation" [value]="benefied.id">
              <label translate>{{ benefied.name }}</label>
            </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field class="field-ppcn">
          <mat-label translate>adaptationAction.form2.potentialCoBenefits</mat-label>
          <input type="text" matInput formControlName="potentialCoBenefitsCtrl" />
          <mat-error *ngIf="formArray?.get([0])?.get('potentialCoBenefitsCtrl')?.hasError('required')" translate>
            errorLabel.fieldRequired
          </mat-error>
          <mat-error *ngIf="formArray?.get([0])?.get('potentialCoBenefitsCtrl')?.hasError('maxlength')" translate>
            errorLabel.maxLengthExceeded
          </mat-error>
        </mat-form-field>

        <mat-form-field class="field-ppcn" appearance="fill">
          <mat-label translate>adaptationAction.form2.AAODS</mat-label>
          <mat-select formControlName="adaptationActionODSCtrl" multiple>
            <mat-option *ngFor="let element of ods" [value]="element.code">
              <label translate>{{ element.name }}</label>
            </mat-option>
          </mat-select>
        </mat-form-field>

        <div class="button-box flex flex-row justify-end items-center">
          <button
            mat-raised-button
            color="primary"
            type="button"
            [disabled]="formArray?.get([0]).invalid"
            (click)="stepper.next()"
          >
            <span translate>general.next</span>
          </button>
        </div>
      </mat-step>

      <mat-step formGroupName="1" [stepControl]="formArray?.get([1])">
        <ng-template matStepLabel>
          <span translate>general.GeographicLocation</span>
        </ng-template>

        <label translate>adaptationAction.form2.appScale</label>
        <mat-radio-group
          (change)="changeLocationValidations($event.value)"
          #appScaleControl="matRadioGroup"
          formControlName="appScaleCtrl"
          class="custom-radio-group"
        >
          <mat-radio-button [value]="1">
            <label translate>Nacional </label>
          </mat-radio-button>
          <mat-radio-button [value]="2">
            <label translate>Regional</label>
          </mat-radio-button>
          <mat-radio-button [value]="3">
            <label translate>Local</label>
          </mat-radio-button>
        </mat-radio-group>

        <mat-form-field
          *ngIf="appScaleControl.value == 2 || appScaleControl.value == 3"
          class="field-ppcn"
          appearance="fill"
        >
          <mat-label translate>adaptationAction.form2.AAProvince</mat-label>
          <mat-select
            (selectionChange)="selectProvince($event.value)"
            multiple
            formControlName="adaptationActionProvinceCtrl"
          >
            <mat-option *ngFor="let province of provinces" [value]="province.id">
              <label translate>{{ province.name }}</label>
            </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field
          *ngIf="appScaleControl.value == 2 || appScaleControl.value == 3"
          class="field-ppcn"
          appearance="fill"
        >
          <mat-label translate>adaptationAction.form2.AACanton</mat-label>
          <mat-select
            multiple
            (selectionChange)="selectCanton($event.value)"
            formControlName="adaptationActionCantonCtrl"
          >
            <mat-optgroup *ngFor="let group of cantonesToShow" [label]="group.provinceName">
              <mat-option *ngFor="let canton of group.cantones" [value]="canton.id">
                {{ canton.name }}
              </mat-option>
            </mat-optgroup>
          </mat-select>
        </mat-form-field>

        <mat-form-field *ngIf="appScaleControl.value == 3" class="field-ppcn" appearance="fill">
          <mat-label translate>adaptationAction.form2.AADistrict</mat-label>
          <mat-select multiple formControlName="adaptationActionDistritCtrl">
            <mat-optgroup *ngFor="let group of cdistrictsToShow" [label]="group.cantonName">
              <mat-option *ngFor="let district of group.districts" [value]="district.id">
                {{ district.name }}
              </mat-option>
            </mat-optgroup>
          </mat-select>
        </mat-form-field>

        <div class="flex flex-col gap-2">
          <label translate>adaptationAction.form2.narrativeActionPlace</label>
          <mat-form-field class="field-ppcn">
            <input type="text" matInput formControlName="adaptationActionDescriptionNarrativeCtrl" />
            <mat-error
              *ngIf="formArray?.get([1])?.get('adaptationActionDescriptionNarrativeCtrl')?.hasError('required')"
              translate
            >
              errorLabel.fieldRequired
            </mat-error>
            <mat-error
              *ngIf="formArray?.get([1])?.get('adaptationActionDescriptionNarrativeCtrl')?.hasError('maxlength')"
              translate
            >
              errorLabel.maxLengthExceeded
            </mat-error>
          </mat-form-field>
        </div>

        <div class="flex flex-col gap-2">
          <label translate>adaptationAction.form2.attachGeographicalLocation</label>
          <div class="flex flex-row justify-center">
            <mat-form-field class="field-ppcn">
              <input type="text" matInput formControlName="adaptationActionLocationCtrl" />
              <mat-error translate>errorLabel.fieldRequired</mat-error>
            </mat-form-field>
            <input formControlName="adaptationActionLocationOtherCtrl" type="file" />
          </div>
        </div>

        <div class="button-box flex flex-row justify-end items-center">
          <button (click)="stepper.previous()" mat-button><span translate>general.back</span></button>
          <button
            mat-raised-button
            color="primary"
            type="button"
            [disabled]="formArray?.get([1]).invalid"
            (click)="stepper.next()"
          >
            <span translate>general.next</span>
          </button>
        </div>
      </mat-step>

      <!-- optional for type 1 -->
      <mat-step formGroupName="2" [stepControl]="formArray?.get([2])">
        <ng-template matStepLabel>
          <span translate>adaptationAction.form2.categorizationNationalIntruments</span>
          <mat-icon
            (click)="
              goToLink(
                'https://docs.google.com/spreadsheets/d/1fDSEUgkJgE8Xq1sLggu4ds4aS2EmxedW/edit?usp=sharing&ouid=110424914348129594837&rtpof=true&sd=true'
              )
            "
            [matTooltip]="'adaptationAction.form2.categorizationNationalIntrumentsTooltip' | translate"
            >info</mat-icon
          >
        </ng-template>
        <div class="my-2 flex flex-col justify-center items-start rounded bg-gray-100 border-2 border-gray-200 p-2">
          <span translate>general.optional</span>
        </div>
        <div class="finance-container flex flex-col justify-start items-start" formArrayName="themeCtrl">
          <div
            class="max-container"
            *ngFor="let element of form.controls.formArray['controls'][2].controls['themeCtrl'].controls; let i = index"
          >
            <mat-card class="finance-container flex flex-col justify-start items-start" [formGroupName]="i">
              <mat-form-field class="field-ppcn" appearance="fill">
                <mat-label translate>adaptationAction.form2.selectTopic</mat-label>
                <mat-select
                  (selectionChange)="changeSubTopics($event.value, i)"
                  formControlName="adaptationActionThemeCtrl"
                >
                  <mat-option *ngFor="let topic of topics[i]" [value]="topic.id">
                    <label translate>{{ topic.description }}</label>
                  </mat-option>
                </mat-select>
              </mat-form-field>

              <mat-form-field class="field-ppcn" appearance="fill">
                <mat-label translate>adaptationAction.form2.selectSubtopic</mat-label>
                <mat-select
                  (selectionChange)="loadActivities($event.value, i)"
                  formControlName="adaptationActionTypologyCtrl"
                >
                  <mat-option *ngFor="let subTopic of subTopicsToShow[i]" [value]="subTopic.id">
                    <label translate>{{ subTopic.description }}</label>
                  </mat-option>
                </mat-select>
              </mat-form-field>

              <mat-form-field class="field-ppcn" appearance="fill">
                <mat-label translate>adaptationAction.form2.selectActionType </mat-label>
                <mat-select
                  (selectionChange)="fillActivitiesFields($event.value, i)"
                  formControlName="adaptationActionTypeCtrl"
                >
                  <mat-option *ngFor="let element of activities[i]" [value]="element.id">
                    <label translate>{{ element.description ? element.description : 'N/A' }} </label>
                  </mat-option>
                </mat-select>
              </mat-form-field>

              <div class="box-button">
                <button
                  mat-mini-fab
                  color="warn"
                  *ngIf="form.controls.formArray['controls'][2].controls['themeCtrl'].controls.length > 1"
                  (click)="removeThemeCtrl(i)"
                  type="button"
                >
                  <mat-icon>delete forever</mat-icon>
                </button>
              </div>
            </mat-card>
          </div>
          <div class="box-button">
            <button
              (click)="addThemeCtrl(form.controls.formArray['controls'][2].controls['themeCtrl'].controls.length)"
              type="button"
              matRipple
              class="primary-button"
            >
              <span translate>general.addRelationships</span>
            </button>
          </div>
        </div>

        <div class="button-box flex flex-row justify-end items-center">
          <button (click)="stepper.previous()" mat-button><span translate>general.back</span></button>
          <button
            mat-raised-button
            color="primary"
            type="button"
            [disabled]="formArray?.get([2]).invalid"
            (click)="stepper.next()"
          >
            <span translate>general.next</span>
          </button>
        </div>
      </mat-step>

      <!-- optional for type 1 -->
      <mat-step formGroupName="3" [stepControl]="formArray?.get([3])">
        <ng-template matStepLabel>
          <span translate>adaptationAction.form2.relationshipInstruments</span>
        </ng-template>
        <div class="my-2 flex flex-col justify-center items-start rounded bg-gray-100 border-2 border-gray-200 p-2">
          <span translate>general.optional</span>
        </div>
        <label translate>adaptationAction.form2.namePlanningInstrument</label>
        <mat-form-field class="field-ppcn">
          <input type="text" matInput formControlName="adaptationActionInstrumentCtrl" />
          <mat-error translate>errorLabel.fieldRequired</mat-error>
        </mat-form-field>

        <div class="button-box flex flex-row justify-end items-center">
          <button (click)="stepper.previous()" mat-button><span translate>general.back</span></button>
          <button
            mat-raised-button
            color="primary"
            type="button"
            [disabled]="formArray?.get([3]).invalid"
            (click)="stepper.next()"
          >
            <span translate>general.next</span>
          </button>
        </div>
      </mat-step>

      <mat-step formGroupName="4" [stepControl]="formArray?.get([4])">
        <ng-template matStepLabel>
          <span translate>adaptationAction.form2.climateRelatedHazard</span>
        </ng-template>

        <div class="flex flex-col gap-2 mt-2">
          <label translate>adaptationAction.form2.relatedClimateThreat</label>
          <mat-form-field class="field-ppcn" appearance="fill">
            <mat-select multiple #climateValue formControlName="adaptationActionClimateThreatCtrl">
              <mat-option *ngFor="let climate of climateThreat" [value]="climate.id">
                <label translate>{{ climate.name }}</label>
              </mat-option>
            </mat-select>
          </mat-form-field>
        </div>

        <div class="flex flex-col gap-2" *ngIf="climateValue?.value?.includes(climateThreat.length)">
          <mat-label translate>adaptationAction.form2.relatedClimateThreatOther</mat-label>
          <mat-form-field class="field-ppcn">
            <input type="text" matInput formControlName="adaptationActionClimateThreatOtherCtrl" />
            <mat-error translate>errorLabel.fieldRequired</mat-error>
          </mat-form-field>
        </div>

        <div class="flex flex-col gap-2">
          <label translate>adaptationAction.form2.descriptionRelatedClimateThreat</label>
          <div class="flex flex-row justify-center items-stretch gap-4">
            <mat-form-field class="field-ppcn">
              <input matInput formControlName="adaptationActionInfoSourceCtrl" />
              <mat-error translate>errorLabel.fieldRequired</mat-error>
            </mat-form-field>
            <app-upload-button name="filename1" />
            <br />
          </div>
        </div>

        <div class="flex flex-col gap-2">
          <label translate>adaptationAction.form2.descriptionVulnerability</label>
          <div class="flex flex-row justify-center gap-4">
            <mat-form-field class="field-ppcn">
              <input matInput formControlName="descriptionVulnerabilityCtrl" />
              <mat-error
                *ngIf="formArray?.get([4])?.get('descriptionVulnerabilityCtrl')?.hasError('required')"
                translate
              >
                errorLabel.fieldRequired
              </mat-error>
              <mat-error
                *ngIf="formArray?.get([4])?.get('descriptionVulnerabilityCtrl')?.hasError('maxlength')"
                translate
              >
                errorLabel.maxLengthExceeded
              </mat-error>
            </mat-form-field>
            <app-upload-button name="filename2" />
            <br />
          </div>
        </div>

        <div class="flex flex-col gap-2">
          <label translate>adaptationAction.form2.descriptionElementsExposed</label>
          <div class="flex flex-row justify-center gap-4">
            <mat-form-field class="field-ppcn">
              <input matInput formControlName="descriptionElementsExposedCtrl" />
              <mat-error
                *ngIf="formArray?.get([4])?.get('descriptionElementsExposedCtrl')?.hasError('required')"
                translate
              >
                errorLabel.fieldRequired
              </mat-error>
              <mat-error
                *ngIf="formArray?.get([4])?.get('descriptionElementsExposedCtrl')?.hasError('maxlength')"
                translate
              >
                errorLabel.maxLengthExceeded
              </mat-error>
            </mat-form-field>
            <app-upload-button name="filename3" />
            <br />
          </div>
        </div>

        <div class="flex flex-col gap-2">
          <label translate>adaptationAction.form2.descriptionLossesDamages</label>
          <div class="flex flex-row justify-center gap-4">
            <mat-form-field class="field-ppcn">
              <input matInput formControlName="descriptionLossesDamagesCtrl" />
              <mat-error
                *ngIf="formArray?.get([4])?.get('descriptionLossesDamagesCtrl')?.hasError('required')"
                translate
              >
                errorLabel.fieldRequired
              </mat-error>
              <mat-error
                *ngIf="formArray?.get([4])?.get('descriptionLossesDamagesCtrl')?.hasError('maxlength')"
                translate
              >
                errorLabel.maxLengthExceeded
              </mat-error>
            </mat-form-field>
            <app-upload-button name="filename4" />
            <br />
          </div>
        </div>

        <div class="flex flex-col gap-2 w-full">
          <label translate>adaptationAction.form2.descriptionClimateRelatedRisks</label>
          <div class="flex flex-row justify-center gap-4 w-full">
            <mat-form-field class="field-ppcn">
              <input matInput formControlName="descriptionClimateRelatedRisksCtrl" />
              <mat-error
                *ngIf="formArray?.get([4])?.get('descriptionClimateRelatedRisksCtrl')?.hasError('required')"
                translate
              >
                errorLabel.fieldRequired
              </mat-error>
              <mat-error
                *ngIf="formArray?.get([4])?.get('descriptionClimateRelatedRisksCtrl')?.hasError('maxlength')"
                translate
              >
                errorLabel.maxLengthExceeded
              </mat-error>
            </mat-form-field>
            <app-upload-button name="filename4" />
            <br />
          </div>
        </div>

        <div class="button-box flex flex-row justify-end items-center">
          <button (click)="stepper.previous()" mat-button><span translate>general.back</span></button>
          <button
            mat-raised-button
            color="primary"
            type="button"
            [disabled]="formArray?.get([4]).invalid"
            (click)="stepper.next()"
          >
            <span translate>general.next</span>
          </button>
        </div>
      </mat-step>

      <!-- optional for type 1 -->
      <mat-step formGroupName="5" [stepControl]="formArray?.get([5])">
        <ng-template matStepLabel>
          <span translate>adaptationAction.form2.implementation</span>
        </ng-template>
        <div class="my-2 flex flex-col justify-center items-start rounded bg-gray-100 border-2 border-gray-200 p-2">
          <span translate>general.optional</span>
        </div>
        <mat-form-field class="field-ppcn">
          <mat-label translate>adaptationAction.form2.startImplementation</mat-label>
          <input
            matInput
            [placeholder]="'Choose a date' | translate"
            [matDatepicker]="adaptationActionStartDate"
            formControlName="adaptationActionStartDateCtrl"
          />

          <mat-datepicker-toggle matSuffix [for]="adaptationActionStartDate"></mat-datepicker-toggle>
          <mat-datepicker #adaptationActionStartDate startView="year"></mat-datepicker>

          <mat-error translate>errorLabel.fieldRequired</mat-error>
        </mat-form-field>

        <mat-form-field class="field-ppcn">
          <mat-label translate>adaptationAction.form2.endImplementation</mat-label>
          <input
            matInput
            [placeholder]="'Choose a date' | translate"
            [matDatepicker]="adaptationActionEndDate"
            formControlName="adaptationActionEndDateCtrl"
          />

          <mat-datepicker-toggle matSuffix [for]="adaptationActionEndDate"></mat-datepicker-toggle>
          <mat-datepicker #adaptationActionEndDate startView="year"></mat-datepicker>

          <mat-error translate>errorLabel.fieldRequired</mat-error>
        </mat-form-field>

        <mat-form-field class="field-ppcn">
          <mat-label translate>adaptationAction.form2.responsibleExecuting</mat-label>
          <input type="text" matInput formControlName="adaptationActionEntityCtrl" />
          <mat-error *ngIf="formArray?.get([5])?.get('adaptationActionEntityCtrl')?.hasError('required')" translate>
            errorLabel.fieldRequired
          </mat-error>
          <mat-error *ngIf="formArray?.get([5])?.get('adaptationActionEntityCtrl')?.hasError('maxlength')" translate>
            errorLabel.maxLengthExceeded
          </mat-error>
        </mat-form-field>

        <mat-form-field class="field-ppcn">
          <mat-label translate>adaptationAction.form2.otherEntitiesInvolved</mat-label>
          <input type="text" matInput formControlName="adaptationActionEntityOthersCtrl" />
          <mat-error
            *ngIf="formArray?.get([5])?.get('adaptationActionEntityOthersCtrl')?.hasError('required')"
            translate
          >
            errorLabel.fieldRequired
          </mat-error>
          <mat-error
            *ngIf="formArray?.get([5])?.get('adaptationActionEntityOthersCtrl')?.hasError('maxlength')"
            translate
          >
            errorLabel.maxLengthExceeded
          </mat-error>
        </mat-form-field>

        <mat-form-field class="field-ppcn">
          <mat-label translate>adaptationAction.form2.actionCode</mat-label>
          <input
            disabled
            type="text"
            matInput
            [value]="
              'AA' +
              adaptationActionMap[reportingEntityTypeControl.value ? reportingEntityTypeControl.value : 0] +
              adaptationActionsExtension
            "
          />
          <mat-error translate>errorLabel.fieldRequired</mat-error>
          <mat-error *ngIf="formArray?.get([5])?.get('adaptationActionCodeCtrl')?.hasError('required')" translate>
            errorLabel.fieldRequired
          </mat-error>
          <mat-error *ngIf="formArray?.get([5])?.get('adaptationActionCodeCtrl')?.hasError('maxlength')" translate>
            errorLabel.maxLengthExceeded
          </mat-error>
        </mat-form-field>

        <div class="button-box flex flex-row justify-end items-center">
          <button (click)="stepper.previous()" mat-button><span translate>general.back</span></button>
          <button
            mat-raised-button
            color="primary"
            type="button"
            [disabled]="formArray?.get([5]).invalid"
            (click)="submitForm()"
          >
            <span translate>general.next</span>
          </button>
        </div>
      </mat-step>
    </mat-vertical-stepper>
  </form>
</div>
